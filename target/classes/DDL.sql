CREATE SCHEMA wedding_planner;
USE wedding_planner;

# Creating tables
CREATE TABLE users(
ID INT NOT NULL,
email VARCHAR(30) NOT NULL,
password VARCHAR(28) NOT NULL,
type VARCHAR(10) NOT NULL,
username VARCHAR(15) NOT NULL,
phonenumber VARCHAR(15) DEFAULT NULL,
PRIMARY KEY(ID),
CONSTRAINT Check_User_Type CHECK (type IN ('admin', 'sp', 'customer')),
UNIQUE (email)
);

CREATE TABLE services(
ID INT NOT NULL,
type VARCHAR(10) NOT NULL,
PRIMARY KEY(ID),
CONSTRAINT Check_Service_Type CHECK (type IN ('person', 'place'))
);

CREATE TABLE persons(
ID INT NOT NULL,
name VARCHAR(32) NOT NULL,
description VARCHAR(300) NOT NULL,
rate FLOAT NOT NULL,
owner_ID INT NOT NULL,
cost INT,
job VARCHAR(20),
PRIMARY KEY(ID),
CONSTRAINT Persons_ID_FK FOREIGN KEY (ID) REFERENCES services(ID) ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT Owner_ID_Persons_FK FOREIGN KEY (owner_ID) REFERENCES users(ID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE places(
ID INT NOT NULL,
name VARCHAR(32) NOT NULL,
description VARCHAR(300) NOT NULL,
rate FLOAT NOT NULL,
owner_ID INT NOT NULL,
cost INT NOT NULL,
location VARCHAR(20) NOT NULL,
capacity INT NOT NULL,
category VARCHAR(20),
PRIMARY KEY(ID),
CONSTRAINT Places_ID_FK FOREIGN KEY (ID) REFERENCES services(ID) ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT Owner_ID_Places_FK FOREIGN KEY (owner_ID) REFERENCES users(ID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE busy(
ID INT NOT NULL,
date DATE NOT NULL,
PRIMARY KEY(ID,date),
CONSTRAINT Busy_Service_ID_FK FOREIGN KEY (ID) REFERENCES services(ID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE person_locations(
ID INT NOT NULL,
location VARCHAR(24) NOT NULL,
PRIMARY KEY(ID,location),
CONSTRAINT Person_Location_ID_FK FOREIGN KEY (ID) REFERENCES persons(ID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE pictures(
ID INT NOT NULL,
URL VARCHAR(128) NOT NULL,
PRIMARY KEY(ID,url),
CONSTRAINT Pictures_ID_FK FOREIGN KEY (ID) REFERENCES services(ID) ON UPDATE CASCADE ON DELETE CASCADE
);

# Creating Stored procedures
USE DELIMITER //
CREATE PROCEDURE get_service(service_ID INT)
BEGIN
	SET @service_table = (SELECT type FROM services WHERE ID = service_ID);
	IF @service_table = "place" THEN
		 (SELECT  * FROM (places NATURAL JOIN services) WHERE ID = service_ID);
	ELSE
		 (SELECT  * FROM (persons NATURAL JOIN services)  WHERE ID = service_ID);
	END IF;
END//
USE DELIMITER ;
